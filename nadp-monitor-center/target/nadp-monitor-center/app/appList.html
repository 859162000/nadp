<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- HTTP 1.1 -->
    <meta http-equiv="pragma" content="no-cache">
    <!-- HTTP 1.0 -->
    <meta http-equiv="cache-control" content="no-cache">
    <title></title>
</head>
<script src="../js/jquery.CustomePagination.js" type="text/javascript"></script>
<script src="../js/pagination.js" type="text/javascript"></script>

<body>
<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Application list <small>[app列表]</small></h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li><a href="#"><i class="fa fa-chevron-up"></i></a>
                    </li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><i class="fa fa-wrench"></i></a>
                    </li>
                    <li><a href="#" id="closePage"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            </br>
            <div class="x_content">
                名称：
                <input class="date-picker" type="text" id="name">
                <input class="btn btn-primary" type="button" value="查询" id="query">
                <input id="addbtn"  class="btn btn-primary" type="button" data-target=".bs-example-modal-lg" data-toggle="modal" value="新增">
            </div>
            </br>
            <div class="x_content">
                <table id="example" class="table table-striped responsive-utilities jambo_table">
                    <thead>
                    <tr class="headings">
                        <th> 名称 </th>
                        <th>APP_KEY </th>
                        <th>创建时间 </th>
                        <th>是否有效 </th>
                        <th>描述 </th>
                        <th>操作 </th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <br />
    <br />
    <br />
    <div id="add" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">新增</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-label-left" >
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="add_name" >名称 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="add_name" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="add_appKey" >APP_KEY <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="add_appKey" type="text" required="required" readonly class="form-control col-md-7 col-xs-12">
                            </div>
                            <input id="add_value_btn" type="button" required="required" class="btn btn-primary" value="生成KEY">
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布环境 <span class="required">*</span>
                            </label>
                            <div id="deployEnv" class="col-md-9 col-sm-9 col-xs-12"　style="overflow:auto;">

                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="description" >描述 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="description" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="addCommit">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div id="modify" class="modal fade modify-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <input type="hidden" id="modifyId" />
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" >修改</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-label-left" >
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modify_name" >名称 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="modify_name" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modify_appKey" >APP_KEY <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="modify_appKey" type="text" required="required" readonly class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布环境 <span class="required">*</span>
                            </label>
                            <div id="modifyEnv" class="col-md-9 col-sm-9 col-xs-12"　style="overflow:auto;">

                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modifyDescription" >描述 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="modifyDescription" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="modifyCommit">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div id="delete" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
        <input type="hidden" id="deleteId">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel2">提示</h4>
                </div>
                <div class="modal-body">
                    <h4>确认作废?</h4>
                    <p>作废数据将被失效,为逻辑删除.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">否</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" id="confirmDelete">是</button>
                </div>
            </div>
        </div>
    </div>
    <div id="notify" class="modal fade notify_app" tabindex="-1" role="dialog" aria-hidden="true">
        <input type="hidden" id="notifyApp" />
        <input type="hidden" id="notifyAppKey" />
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel3">通知</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-label-left" >
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >通知环境 <span class="required">*</span>
                            </label>
                            <div id="notifyEnv" class="col-md-9 col-sm-9 col-xs-12"　style="overflow:auto;">

                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="notifyCommit">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="../js/datatables/js/jquery.dataTables.js"></script>
<script src="../js/datatables/tools/js/dataTables.tableTools.js"></script>
<script>
    function dealUpdateData(data){
        //envList
        $("#modifyEnv").html("");
        $.each(data.info.envList,function(index,env){
            var checked = false;
            $.each(data.info.relList,function(index,envRel){
                if(envRel.envId == env.id){
                    checked = true;
                    return true;
                }
            })
            if(checked){
                $("#modifyEnv").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input checked name="modifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
            }else{
                $("#modifyEnv").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input name="modifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
            }
        })

    }
    $(function(){
        $(document).off("click","#addbtn");
        $(document).off("click","#add_value_btn");
        $(document).off("click","#addCommit");
        $(document).off("click","#notify");
        $(document).off("click","#modifyBtn");
        $(document).off("click","#confirmDelete");
        $(document).off("click","#deleteBtn");
        $(document).off("click","#query");
        $(document).on("click","#query",function(){
            $('#example').dataTable().fnClearTable();
        });
        $(document).on("click","#confirmDelete",function(){
            $.ajax(
                    {
                        type: "DELETE",
                        url: "/api/application/delete" ,
                        data:JSON.stringify({"id":$("#deleteId").val()}),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        });
        $(document).on("click","#deleteBtn",function(){
            $("#deleteId").val($(this).attr("delete-id"))
        });


        $(document).on("click","#modifyCommit",function(){
            var envArr = [];
            $.each($("input[name='modifyEnv']:checked"),function(index,env){
                envArr.push($(env).attr("data"));
            });
            var data =  {
                "id":$("#modifyId").val(),
                "name":$("#modify_name").val(),
                "env":envArr,
                "description":$("#modifyDescription").val()
            };
            $.ajax(
                    {
                        type: "PUT",
                        url: "/api/application/update" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        });
        $(document).on("click","#modifyBtn",function(){
            $("#modifyId").val($(this).attr("modify-id"));
            var data = JSON.parse($(this).attr("modify-data"));
            $("#modify_name").val(data.name)
            $("#modifyDescription").val(data.description);
            $("#modify_appKey").val(data.appKey);
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/application/update/listRel" ,
                        data:JSON.stringify({"appId":$(this).attr("modify-id")}),
                        dataType:"json",
                        success: function(data){
                            dealUpdateData(data);
                        }
                    }
            )

        });
        $(document).on("click","#addbtn",function(){
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/env/listAll" ,
                        data:JSON.stringify({"status":"1"}),
                        dataType:"json",
                        success: function(data){
                            if(data.code == "10000"){
                                $("#deployEnv").html("");
                                $.each(data.info.aaData,function(index,env){
                                    $("#deployEnv").append('<div class="checkbox"></div>').find("div:last")
                                            .append('<label></label>').find("label")
                                                .append('<input name="env" type="checkbox" data="'+env.id+'"> '+env.name);
                                })
                            }
                        }
                    }
            )
        });
        $(document).on("click","#add_value_btn",function (event) {
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/application/genAppKey" ,
                        data:{},
                        dataType:"json",
                        success: function(data){
                            $("#add_appKey").val(data.info.appKey);
                        }
                    }
            )
        });
        $(document).on("click","#addCommit",function(){
            var envArr = [];
            $.each($("input[name='env']:checked"),function(index,env){
                envArr.push($(env).attr("data"));
            });
            var data =  {
                             "name":$("#add_name").val(),
                             "appKey":$("#add_appKey").val(),
                             "env":envArr,
                             "description":$("#description").val()
                        };
            $.ajax(
                    {
                        type: "PUT",
                        url: "/api/application/insert" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        });
        $(document).on("click","#notifyBtn",function(){
            $("#notifyApp").val($(this).attr("notify_app_id"));
            $("#notifyAppKey").val($(this).attr("notify_app_key"));

            $.ajax(
                    {
                        type: "POST",
                        url: "/api/env/listAll" ,
                        data:JSON.stringify({"status":"1"}),
                        dataType:"json",
                        success: function(data){
                            if(data.code == "10000"){
                                $("#notifyEnv").html("");
                                $.each(data.info.aaData,function(index,env){
                                    $("#notifyEnv").append('<div class="checkbox"></div>').find("div:last")
                                            .append('<label></label>').find("label")
                                            .append('<input name="notifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
                                })
                            }
                        }
                    }
            )
        });
        $(document).on("click","#notifyCommit",function (event) {
            var envs = [];
            $.each($("input[name='notifyEnv']:checked"),function(index,env){
                envs.push($(env).attr("data"));
            });
            console.log($(event.target).html())
            var data = {
                envs:envs,
                appId:$("#notifyApp").val(),
                appKey:$("#notifyAppKey").val()
            }
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/center/notify" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            if(data.code == "10000"){
                                $("#notifyEnv").html("");
                                $.each(data.info.aaData,function(index,env){
                                    $("#notifyEnv").append('<div class="checkbox"></div>').find("div:last")
                                            .append('<label></label>').find("label")
                                            .append('<input name="notifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
                                })
                            }
                        }
                    }
            )
        })
    })
    var asInitVals = new Array();

    function retrieveData(sSource,aoData, fnCallback){
        var ajaxParamData = new Object();
        $.each(aoData,function(index,data){
            if(data.name == "sEcho"){
                ajaxParamData.sEcho = data.value+"";
            }else if(data.name == "iDisplayStart"){
                ajaxParamData.iDisplayStart = data.value+"";
            }else if(data.name == "iDisplayLength"){
                ajaxParamData.iDisplayLength = data.value+"";
            }
        });
        ajaxParamData.name = $('#name').val();
       $.post(sSource,JSON.stringify(ajaxParamData),function(result){
                                            fnCallback(result.info);
                                }, "json");
    }

     function init() {
         var oTable = $('#example').dataTable({
             "sAjaxDataProp" : "aaData",
             "aoColumnDefs": [
                 {
                     'bSortable': false,
                     'aTargets': [0,1,2,3,4,5]
                 } //disables sorting for column one
             ],
             "aoColumns" : [{
                 "data" : "name"
             },{
                 "data" : "appKey"
             },{
                 "data" : "createDate"
             },{
                 "data" : "status",
                 "mRender":function(data,type,full){
                     if(data+"" == "1"){
                         return "有效";
                     }else if(data+"" == "0"){
                         return "无效";
                     }else{
                         return "未知";
                     }
                 }
             },{
                 "data" : "description"
             },{
                 "data" : "id",
                 "mRender":function(data,type,full){
                     var appKey = full.appKey;
                     return  '<div class="btn-group" >' +
                             '<a id="notifyBtn" class="btn btn-xs btn-info" data-target=".notify_app" data-toggle="modal" notify_app_id="'+data+'" notify_app_key="'+appKey+'">通知</a>' +
                             "<a id='modifyBtn' class='btn btn-xs btn-info' data-target='.modify-modal' data-toggle='modal' modify-data='"+JSON.stringify(full)+"'  modify-id='"+data+"'>修改</a>" +
                             "<a id='deleteBtn' class='btn btn-xs btn-info' data-target='.bs-example-modal-sm' data-toggle='modal' delete-id='"+data+"'>删除</a>" +
                             '</div>';
                 }
             } ],
             "bFilter": false,
             "bAutoWidth": true, //自适应宽度
             "bLengthChange":false,
             "sPaginationType": "full_numbers",
             "sAjaxSource":"/api/application/list",
             "fnServerData": retrieveData,// 获取数据的处理函数
             "bServerSide" : true,
             "bDestroy": true
         });
         $("tfoot input").keyup(function () {
             /* Filter on the column based on the index of this element's parent <th> */
             oTable.fnFilter(this.value, $("tfoot th").index($(this).parent()));
         });
         $("tfoot input").each(function (i) {
             asInitVals[i] = this.value;
         });
         $("tfoot input").blur(function (i) {
             if (this.value == "") {
                 this.className = "search_init";
                 this.value = asInitVals[$("tfoot input").index(this)];
             }
         });
     }
    init();
</script>
</html>