<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- HTTP 1.1 -->
    <meta http-equiv="pragma" content="no-cache">
    <!-- HTTP 1.0 -->
    <meta http-equiv="cache-control" content="no-cache">
    <title></title>
</head>
<script src="../js/jquery.CustomePagination.js" type="text/javascript"></script>
<script src="../js/pagination.js" type="text/javascript"></script>

<body>
<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Configuration list <small>[配置列表]</small></h2>
                <ul class="nav navbar-right panel_toolbox">
                    <li>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </li>
                    <li class="dropdown">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </li>
                    <li><a href="#" id="closePage"><i class="fa fa-close"></i></a>
                    </li>
                </ul>
                <div class="clearfix"></div>
            </div>
            </br>
            <div class="x_content">
                名称：
                <input class="date-picker" type="text" id="name">
                <input class="btn btn-primary" type="button" id="query" value="查询">
                <input class="btn btn-primary" type="button" data-target=".bs-example-modal-lg" data-toggle="modal" value="新增" id="addbtn">
            </div>
            </br>
            <div class="x_content">
                <table id="example" class="table table-striped responsive-utilities jambo_table">
                    <thead>
                    <tr class="headings">
                        <th> 名称 </th>
                        <th>值 </th>
                        <th>类型 </th>
                        <th>创建时间 </th>
                        <th>是否有效 </th>
                        <th>描述 </th>
                        <th>操作 </th>
                        </th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <br />
    <br />
    <br />
    <div id="add" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" >新增</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-label-left" >
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="add_name" >名称 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="add_name" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="add_value" >值 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="add_value" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="add_type" >类型 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-3 col-xs-12">
                                <select class="form-control" id="add_type" >
                                    <option value="1">持久化类型</option>
                                    <option value="2">内存化类型</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布环境 <span class="required">*</span>
                            </label>
                            <div id="deployEnv" class="col-md-9 col-sm-9 col-xs-12"　style="overflow:auto;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布系统 <span class="required">*</span>
                            </label>
                            <div id="deployApp" class="col-md-9 col-sm-9 col-xs-12"　style="overflow:auto;">

                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="description" >描述 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="description" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="addCommit">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div id="modify" class="modal fade modify-modal" tabindex="-1" role="dialog" aria-hidden="true">
        <input id="modifyId" type="hidden" />
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" >新增</h4>
                </div>
                <div class="modal-body">
                    <div class="form-horizontal form-label-left" >
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modify_name" >名称 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="modify_name" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modify_value" >值 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <input id="modify_value" type="text" required="required" class="form-control col-md-7 col-xs-12">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modify_type" >类型 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-3 col-xs-12">
                                <select class="form-control" id="modify_type" >
                                    <option value="1">持久化类型</option>
                                    <option value="2">内存化类型</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布环境 <span class="required">*</span>
                            </label>
                            <div id="modifyEnv" class="col-md-6 col-sm-3 col-xs-12"　style="overflow:auto;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" >发布系统 <span class="required">*</span>
                            </label>
                            <div id="modifyApp" class="col-md-6 col-sm-3 col-xs-12"　style="overflow:auto;">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-3 col-sm-3 col-xs-12" for="modifyDescription" >描述 <span class="required">*</span>
                            </label>
                            <div class="col-md-6 col-sm-6 col-xs-12">
                                <textarea id="modifyDescription" required="required" class="form-control col-md-7 col-xs-12"></textarea>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                                <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" data-dismiss="modal" id="updateCommit">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>
    <div id="delete" class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-hidden="true">
        <input type="hidden" id="deleteId">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel2">提示</h4>
                </div>
                <div class="modal-body">
                    <h4>确认作废?</h4>
                    <p>作废数据将被失效,为物理删除.</p>

                </div>

                <div class="modal-footer">
                    <div class="form-group">
                        <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-5">
                            <button type="button" class="btn btn-primary" data-dismiss="modal">否</button>
                            <button type="button" class="btn btn-primary" data-dismiss="modal" id="confirmDelete">是</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
<script src="../js/datatables/js/jquery.dataTables.js"></script>
<script src="../js/datatables/tools/js/dataTables.tableTools.js"></script>
<script>
    function dealUpdateData(data){
        //envList
        $("#modifyEnv").html("");
        $.each(data.info.envList,function(index,env){
            var checked = false;
            $.each(data.info.envRel,function(index,envRel){
                if(envRel.envId == env.id){
                    checked = true;
                    return true;
                }
            })
            if(checked){
                $("#modifyEnv").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input checked name="modifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
            }else{
                $("#modifyEnv").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input name="modifyEnv" type="checkbox" data="'+env.id+'"> '+env.name);
            }
        })
        //appList
        $("#modifyApp").html("");
        $.each(data.info.appList,function(index,app){
            var checked = false;
            $.each(data.info.appRel,function(index,appRel){
                if(appRel.appId == app.id){
                    checked = true;
                    return true;
                }
            })
            if(checked){
                $("#modifyApp").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input checked name="modifyApp" type="checkbox" data="'+app.id+'"> '+app.name);
            }else{
                $("#modifyApp").append('<div class="checkbox" class="col-md-9 col-sm-9 col-xs-12"></div>').find("div:last")
                        .append('<label></label>').find("label")
                        .append('<input name="modifyApp" type="checkbox" data="'+app.id+'"> '+app.name);
            }
        })
    }
    $(function(){
        $(document).off("click","#addbtn");
        $(document).off("click","#addCommit");
        $(document).off("click","#confirmDelete");
        $(document).off("click","#query");
        $(document).off("click","#modifyBtn");
        $(document).off("click","#updateCommit");
        $(document).off("click","#deleteBtn");

        $(document).on("click","#query",function(){
            $('#example').dataTable().fnClearTable();
        });
        $(document).on("click","#deleteBtn",function(){
            $("#deleteId").val($(this).attr("delete-id"));
        });
        $(document).on("click","#confirmDelete",function(){
            var data = {
                id:$("#deleteId").val()
            }
            $.ajax(
                    {
                        type: "DELETE",
                        url: "/api/configuration/delete" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        });


        $(document).on("click","#updateCommit",function(event){
            //阻止事件冒泡
            var e=event || window.event;
            if (e && e.stopPropagation){
                e.stopPropagation();
            }else{
                e.cancelBubble=true;
            }
            var envArr = [];
            var appArr = [];
            $.each($("input[name='modifyEnv']:checked"),function(index,env){
                envArr.push($(env).attr("data"));
            });
            $.each($("input[name='modifyApp']:checked"),function(index,env){
                appArr.push($(env).attr("data"));
            });
            var data =  {
                "id":$("#modifyId").val(),
                "name":$("#modify_name").val(),
                "value":$("#modify_value").val(),
                "envArr":envArr,
                "appArr":appArr,
                "type":$("#modify_type").val(),
                "description":$("#modifyDescription").val()
            };
            $.ajax(
                    {
                        type: "PUT",
                        url: "/api/configuration/update" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        });
        $(document).on("click","#addbtn",function(){
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/env/listAll" ,
                        data:JSON.stringify({"status":"1"}),
                        dataType:"json",
                        success: function(data){
                            if(data.code == "10000"){
                                $("#deployEnv").html("");
                                $.each(data.info.aaData,function(index,env){
                                    $("#deployEnv").append('<div class="checkbox"></div>').find("div:last")
                                            .append('<label></label>').find("label")
                                            .append('<input name="env" type="checkbox" data="'+env.id+'"> '+env.name);
                                })
                            }
                        }
                    }
            );
            $.ajax(
                    {
                        type: "POST",
                        url: "/api/application/listAll" ,
                        data:JSON.stringify({"status":"1"}),
                        dataType:"json",
                        success: function(data){
                            if(data.code == "10000"){
                                $("#deployApp").html("");
                                $.each(data.info.aaData,function(index,app){
                                    $("#deployApp").append('<div class="checkbox"></div>').find("div:last")
                                            .append('<label></label>').find("label")
                                            .append('<input name="app" type="checkbox" data="'+app.id+'"> '+app.name);
                                })
                            }
                        }
                    }
            )
        });

        $(document).on("click","#modifyBtn",function(){
            $("#modifyId").val($(this).attr("modify-id"));
            var data = JSON.parse($(this).attr("modify-data"));
            $("#modify_name").val(data.keyName);
            $("#modify_value").val(data.value);
            $("#modifyDescription").val(data.description);
            $("#modify_type").val(data.type);

            $.ajax(
                    {
                        type: "POST",
                        url: "/api/configuration/update/list" ,
                        data:JSON.stringify({"id":$("#modifyId").val()}),
                        dataType:"json",
                        success: function(data){
                            dealUpdateData(data);
                            $("#name").val(data.keyName);
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        })
        $(document).on("click","#addCommit",function(event){
            //阻止事件冒泡
            var e=event || window.event;
            if (e && e.stopPropagation){
                e.stopPropagation();
            }else{
                e.cancelBubble=true;
            }
            var envArr = [];
            var appArr = [];
            $.each($("input[name='env']:checked"),function(index,env){
                envArr.push($(env).attr("data"));
            });
            $.each($("input[name='app']:checked"),function(index,env){
                appArr.push($(env).attr("data"));
            });
            var data =  {     "name":$("#add_name").val(),
                              "value":$("#add_value").val(),
                              "envArr":envArr,
                              "appArr":appArr,
                              "type":$("#add_type").val(),
                              "description":$("#description").val()
                        };
            $.ajax(
                    {
                        type: "PUT",
                        url: "/api/configuration/insert" ,
                        data:JSON.stringify(data),
                        dataType:"json",
                        success: function(data){
                            $('#example').dataTable().fnClearTable();
                        }
                    }
            )
        })
    })
    var asInitVals = new Array();

    function retrieveData(sSource,aoData, fnCallback){
        var ajaxParamData = new Object();
        $.each(aoData,function(index,data){
            if(data.name == "sEcho"){
                ajaxParamData.sEcho = data.value+"";
            }else if(data.name == "iDisplayStart"){
                ajaxParamData.iDisplayStart = data.value+"";
            }else if(data.name == "iDisplayLength"){
                ajaxParamData.iDisplayLength = data.value+"";
            }
        });
       ajaxParamData.name = $('#name').val();
       $.post(sSource,JSON.stringify(ajaxParamData),function(result){
                                            fnCallback(result.info);
                                }, "json");
    }

     function init() {
         var oTable = $('#example').dataTable({
             "sAjaxDataProp" : "aaData",
             "aoColumnDefs": [
                 {
                     'bSortable': false,
                     'aTargets': [0,1,2,3,4,5,6]
                 } //disables sorting for column one
             ],
             "aoColumns" : [{
                 "data" : "keyName"
             },{
                 "data" : "value"
             },{
                 "data" : "type",
                 "mRender":function(data,type,full){
                     if(data+"" == "1"){
                         return "持久型配置";
                     }else if(data+"" == "2"){
                         return "内存型配置";
                     }else{
                         return "未知";
                     }
                 }
             },{
                 "data" : "createDate"
             },{
                 "data" : "status",
                 "mRender":function(data,type,full){
                     if(data+"" == "1"){
                         return "有效";
                     }else if(data+"" == "0"){
                         return "无效";
                     }else{
                         return "未知";
                     }
                 }
             },{
                 "data" : "description"
             },{
                 "data" : "id",
                 "mRender":function(data,type,full){
                     return '<div class="btn-group" >' +
                             "<a id='modifyBtn' class='btn btn-xs btn-info' data-target='.modify-modal' data-toggle='modal' modify-data='"+JSON.stringify(full)+"'  modify-id='"+data+"'>修改</a>" +
                             "<a id='deleteBtn' class='btn btn-xs btn-info' data-target='.bs-example-modal-sm' data-toggle='modal' delete-id='"+data+"'>删除</a>" +
                             '</div>'
                 }
             } ],
             "bFilter": false,
             "bAutoWidth": true, //自适应宽度
             "bLengthChange":false,
             "sPaginationType": "full_numbers",
             "sAjaxSource":"/api/configuration/list",
             "fnServerData": retrieveData,// 获取数据的处理函数
             "bServerSide" : true,
             "bDestroy": true
         });
         $("tfoot input").keyup(function () {
             /* Filter on the column based on the index of this element's parent <th> */
             oTable.fnFilter(this.value, $("tfoot th").index($(this).parent()));
         });
         $("tfoot input").each(function (i) {
             asInitVals[i] = this.value;
         });
         $("tfoot input").blur(function (i) {
             if (this.value == "") {
                 this.className = "search_init";
                 this.value = asInitVals[$("tfoot input").index(this)];
             }
         });
     }
    init();
</script>
</html>